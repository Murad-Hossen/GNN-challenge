name: Score Submission (PR)

on:
  pull_request:
    paths:
      - "submissions/inbox/**/predictions.csv"
      - "submissions/inbox/**/metadata.json"
  workflow_dispatch:

jobs:
  score-submission:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r starter_code/requirements.txt

      - name: Find submission file
        id: submission
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number, per_page: 100 }
            );
            const preds = files
              .map(f => f.filename)
              .filter(f => /^submissions\/inbox\/[^/]+\/[^/]+\/predictions\.csv$/.test(f));
            if (preds.length !== 1) {
              core.setFailed(`Expected exactly 1 predictions.csv, found ${preds.length}: ${preds.join(", ")}`);
              return;
            }
            core.setOutput("predictions", preds[0]);

      - name: Write hidden labels
        run: |
          if [ -z "${TEST_LABELS_CSV}" ]; then
            echo "Missing TEST_LABELS_CSV secret."
            exit 1
          fi
          printf '%s\n' "${TEST_LABELS_CSV}" > /tmp/test_labels_hidden.csv
        env:
          TEST_LABELS_CSV: ${{ secrets.TEST_LABELS_CSV }}

      - name: Score submission
        id: score
        run: |
          result=$(python leaderboard/score_submission.py "${PRED_PATH}" --require-metadata)
          echo "result=${result}" >> "$GITHUB_OUTPUT"
        env:
          HIDDEN_LABELS_PATH: /tmp/test_labels_hidden.csv
          PRED_PATH: ${{ steps.submission.outputs.predictions }}

      - name: Comment score on PR
        uses: actions/github-script@v7
        env:
          SCORE_RESULT: ${{ steps.score.outputs.result }}
          PRED_PATH: ${{ steps.submission.outputs.predictions }}
        with:
          script: |
            const result = JSON.parse(process.env.SCORE_RESULT);
            const body = [
              "### ✅ Submission scored",
              "",
              `**File:** \`${process.env.PRED_PATH}\``,
              `**Validation Accuracy:** ${result.validation_accuracy.toFixed(6)}`,
              `**Validation Macro-F1:** ${result.validation_f1_score.toFixed(6)}`,
              "",
              "_Scores computed using hidden labels._"
            ].join("\n");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            await github.rest.issues.createComment({ owner, repo, issue_number, body });
name: Score Submission (PR)

on:
  pull_request:
    paths:
      - "submissions/inbox/**/predictions.csv"
      - "submissions/inbox/**/metadata.json"
  workflow_dispatch:

jobs:
  score-submission:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r starter_code/requirements.txt

      - name: Find submission file
        id: submission
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number, per_page: 100 }
            );
            const preds = files
              .map(f => f.filename)
              .filter(f => /^submissions\/inbox\/[^/]+\/[^/]+\/predictions\.csv$/.test(f));
            if (preds.length !== 1) {
              core.setFailed(`Expected exactly 1 predictions.csv, found ${preds.length}: ${preds.join(", ")}`);
              return;
            }
            core.setOutput("predictions", preds[0]);

      - name: Write hidden labels
        run: |
          if [ -z "${TEST_LABELS_CSV}" ]; then
            echo "Missing TEST_LABELS_CSV secret."
            exit 1
          fi
          cat <<EOF > /tmp/test_labels_hidden.csv
          ${TEST_LABELS_CSV}
          EOF
        env:
          TEST_LABELS_CSV: ${{ secrets.TEST_LABELS_CSV }}

      - name: Score submission
        id: score
        run: |
          result=$(python leaderboard/score_submission.py "${PRED_PATH}" --require-metadata)
          echo "result=${result}" >> "$GITHUB_OUTPUT"
        env:
          HIDDEN_LABELS_PATH: /tmp/test_labels_hidden.csv
          PRED_PATH: ${{ steps.submission.outputs.predictions }}

      - name: Comment score on PR
        uses: actions/github-script@v7
        env:
          SCORE_RESULT: ${{ steps.score.outputs.result }}
          PRED_PATH: ${{ steps.submission.outputs.predictions }}
        with:
          script: |
            const result = JSON.parse(process.env.SCORE_RESULT);
            const body = [
              "### ✅ Submission scored",
              "",
              `**File:** \`${process.env.PRED_PATH}\``,
              `**Validation Accuracy:** ${result.validation_accuracy.toFixed(6)}`,
              `**Validation Macro-F1:** ${result.validation_f1_score.toFixed(6)}`,
              "",
              "_Scores computed using hidden labels._"
            ].join("\n");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            await github.rest.issues.createComment({ owner, repo, issue_number, body });
